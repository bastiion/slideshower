<html>
<head>
  <title>File upload Node.</title>
  <link rel="stylesheet" href="/semantic-ui/dist/components/reset.css">
  <link rel="stylesheet" href="/semantic-ui/dist/semantic.css">
  <style>
    .preview {
      width: 50px;
    }
  </style>
</head>
<body>
<div class="ui text container upload-form">
  <h1 class="ui dividing header">1. Ein Bild oder Video hochladen</h1>
  <form class="ui form" id="uploadForm"
        enctype="multipart/form-data"
        action="/api/photo"
        method="post">
    <div class="field">
      <label>Bild oder Video</label>
      <input type="file" name="userFile" multiple/>
    </div>
    <div class="field">
      <label>Dauer der Darstellung in Sekunden</label>
      <input type='number' id='duration' name='duration'><br>
    </div>
    <div class="field">
      <div class="ui checkbox">
        <input type="checkbox" tabindex="0" class="hidden">
        <label>Ich akzeptiere die <a href="conditions.html">Bedingungen</a></label>
      </div>
    </div>
    <button class="ui button" type="submit">Medien zum Kunstwerk übermitteln</button>
    <span id="status"></span>
  </form>
</div>
<div class="ui text container sortable-content">
  <h1 class="ui dividing header">Playlist erstellen</h1>
  <div id="wrap" class="ui list items">
  </div>
</div>
<div class="ui basic modal" id="confirmDeleteModal">
  <div class="ui icon header">
    <i class="archive icon"></i>
    <span class="modal-title">Medien Element entfernen?</span>
  </div>
  <div class="content">
    <p>Dies wird die Datei vom Server unwiderrufbar löschen und aus allen Playlists entfernen.</p>
  </div>
  <div class="actions">
    <div class="ui red basic cancel inverted button">
      <i class="remove icon"></i>
      Nein
    </div>
    <div class="ui green ok inverted button confirm-media-element-delete-btn">
      <i class="checkmark icon"></i>
      Ja
    </div>
  </div>
</div>
<script src="jquery/dist/jquery.min.js"></script>
<script src="jquery-form/dist/jquery.form.min.js"></script>
<script src="sortablejs/Sortable.js"></script>
<script src="jquery-sortablejs/jquery-sortable.js"></script>
<script src="semantic-ui/dist/semantic.js"></script>
<script src="public/client.js"></script>
<script>

  $(document).ready(function () {
    let currentMediaElementItemJQ;

    function showDeleteMediaElementConfirmModal(event) {
      const dialog = $("#confirmDeleteModal");
      currentMediaElementItemJQ = $(event.target).closest('.media-element-item');
      $(".modal-title", dialog).text(`${currentMediaElementItemJQ.attr('data-media-element-file-name')} entfernen?`);
      dialog.modal('show');
    }

    $(".confirm-media-element-delete-btn").on('click', (event) => {
      deleteFile(currentMediaElementItemJQ.attr('data-media-element-file-name')).then(() => {
        currentMediaElementItemJQ.remove();
      });
    });
    $(document).on("playlist-updated", (event) => {
      const playl = event.detail.playlist;
      if (!Array.isArray(playl)) return;
      const wrapElement = $("#wrap");
      wrapElement.empty();

      for (let mediaFile of playl) {
        const mediaPath = uploadPath + mediaFile.fileName;
        const isImage = mediaFile.mimeType.indexOf("image/") === 0;
        const isVideo = mediaFile.mimeType.indexOf("video/") === 0;
        if (!isImage && !isVideo) continue;

        const mediaElement = isImage ? `<img src='${mediaPath}'>` : `<video class="image" muted src='${mediaPath}'></video>`;

        wrapElement.append(`
  <div class="ui item media-element-item" data-media-element-id="${mediaFile._id}" data-media-element-file-name="${mediaFile.fileName}">
    <div class="ui tiny images">
    ${mediaElement}
    </div>
    <div class="middle aligned content">
      ${mediaFile.fileName} <br>
      Dauer in Sekunden<input type="number" name="duration" class="duration-change-input" value="${mediaFile.duration}">
      <div class="ui vertical animated button delete-media-btn" tabindex="0">
        <div class="hidden content">delete</div>
        <div class="visible content">
          <i class="trash icon"></i>
        </div>
      </div>
    </div>
  </div>
`
        )
      }
      $(".delete-media-btn", wrapElement).on('click', showDeleteMediaElementConfirmModal);
      wrapElement.sortable({
        onUpdate: event => {
          const  playlistChangedOrder = [];
          $(event.to).children('.media-element-item').each((i, item) => {
            playlistChangedOrder.push( {
              _id: $(item).attr('data-media-element-id'),
              orderIndex: i
            });
          });
          updatePlaylistOrder(playlistChangedOrder);
        }
      });
      $(".duration-change-input").on('focusout', (event) => {
        let _currentMediaElementItemJQ = $(event.target).closest('.media-element-item');
        let duration = parseInt($(event.target).val());
        if(!isNaN(duration) && duration > 0 ) {
          updateFile(_currentMediaElementItemJQ.attr('data-media-element-id'), {
            duration: duration
          });
        }
      });
    });

    $('#uploadForm').submit(function () {
      $("#status").empty().text("File is uploading...");
      $(this).ajaxSubmit({
        error: function (xhr) {
          status('Error: ' + xhr.status);
        },
        success: function (response) {
          console.log(response);
          $("#status").empty().text(response);
        }
      });
      return false;
    });
  });

</script>
</body>
</html>