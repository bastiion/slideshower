<html>
<head>
  <title>File upload Node.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/fomantic-ui/dist/components/reset.css">
  <link rel="stylesheet" href="/fomantic-ui/dist/semantic.css">
  <style>
    .grabbable {
      cursor: move; /* fallback if grab cursor is unsupported */
      cursor: grab;
      cursor: -moz-grab;
      cursor: -webkit-grab;
    }
  </style>
</head>
<body>
<div class="ui text container upload-form">
  <a href="/public/slideshow.html">Zurück zur Slideshow</a>
  <h1 class="ui dividing header">1. Ein Bild oder Video hochladen</h1>
  <form class="ui form" id="uploadForm"
        enctype="multipart/form-data"
        action="/api/photo"
        method="post">
    <div class="field">
      <label>Bild oder Video</label>
      <input type="file" name="userFile" multiple/>
    </div>
    <div class="field">
      <label>Dauer der Darstellung in Sekunden</label>
      <input type='number' id='duration' name='duration'><br>
    </div>
    <div class="field">
      <div class="ui checkbox accept-conditions">
        <input type="checkbox" tabindex="0" class="hidden">
        <label>Ich akzeptiere die <a href="conditions.html">Bedingungen</a></label>
      </div>
    </div>
    <button class="ui button disabled" type="submit">Medien zum Kunstwerk übermitteln</button>
    <span id="status"></span>
  </form>
</div>




<div class="ui text container sortable-content">
  <h1 class="ui dividing header">Playlist erstellen</h1>
  <div id="wrap" class="ui list relaxed items">
  </div>
</div>

<div class="ui basic modal" id="confirmRemoveModal">
  <div class="ui icon header">
    <i class="archive icon"></i>
    <span class="modal-title">Medien Element aus Playlist?</span>
  </div>
  <div class="content">
    <p>Dies wird aus der Playlists entfernt.</p>
  </div>
  <div class="actions">
    <div class="ui red basic cancel inverted button">
      <i class="remove icon"></i>
      Nein
    </div>
    <div class="ui green ok inverted button confirm-media-element-remove-btn">
      <i class="checkmark icon"></i>
      Ja
    </div>
  </div>
</div>
<div class="ui basic modal" id="confirmDeleteModal">
  <div class="ui icon header">
    <i class="trash icon"></i>
    <span class="modal-title">Medien Element entfernen?</span>
  </div>
  <div class="content">
    <p>Dies wird die Datei vom Server unwiderrufbar löschen und aus allen Playlists entfernen.</p>
  </div>
  <div class="actions">
    <div class="ui red basic cancel inverted button">
      <i class="remove icon"></i>
      Nein
    </div>
    <div class="ui green ok inverted button confirm-media-element-delete-btn">
      <i class="checkmark icon"></i>
      Ja
    </div>
  </div>
</div>
<script src="/public/sha.js"></script>
<script src="jquery/dist/jquery.min.js"></script>
<script src="jquery-form/dist/jquery.form.min.js"></script>
<script src="sortablejs/Sortable.js"></script>
<script src="jquery-sortablejs/jquery-sortable.js"></script>
<script src="imagesloaded/imagesloaded.pkgd.min.js"></script>
<script src="fomantic-ui/dist/semantic.js"></script>
<script src="robust-websocket/robust-websocket.js"></script>
<script src="public/client.js"></script>
<script>

  $(document).ready(function () {
    let currentMediaElementItemJQ;
    $('.ui.checkbox.accept-conditions').checkbox({
          onChecked: function () {
            $('button[type="submit"]').removeClass("disabled");
          },
          onUnchecked: function () {
            $('button[type="submit"]').addClass("disabled");
          }
        }
    );

    function showDeleteMediaElementConfirmModal(event) {
      const dialog = $("#confirmDeleteModal");
      currentMediaElementItemJQ = $(event.target).closest('.media-element-item');
      $(".modal-title", dialog).text(`${currentMediaElementItemJQ.attr('data-media-element-file-name')} entfernen?`);
      dialog.modal('show');
    }

    $(".confirm-media-element-delete-btn").on('click', (event) => {
      deleteFile(currentMediaElementItemJQ.attr('data-media-element-file-name')).then(() => {
        currentMediaElementItemJQ.remove();
      });
    });
    function showRemoveMediaElementConfirmModal(event) {
      const dialog = $("#confirmRemoveModal");
      currentMediaElementItemJQ = $(event.target).closest('.media-element-item');
      $(".modal-title", dialog).text(`${currentMediaElementItemJQ.attr('data-media-element-file-name')} aus Playlist entfernen?`);
      dialog.modal('show');
    }

    $(".confirm-media-element-remove-btn").on('click', (event) => {
      const mediaElementID = currentMediaElementItemJQ.attr('data-media-element-id');
      if(typeof mediaElementID === 'string' && mediaElementID.length > 0) {
        removeMediaElementFromPlaylist(mediaElementID).then(() => {
          currentMediaElementItemJQ.remove();
        });
      }
    });
    $(document).on("playlist-updated", (event) => {
      const playl = event.detail.playlist;
      if (!Array.isArray(playl)) return;
      const wrapElement = $("#wrap");
      wrapElement.empty();

      for (let mediaFile of playl) {
        const mediaPath = uploadPath + mediaFile.fileName;
        const mimeType = mediaFile.mimeType;
        const isImage = mimeType.indexOf("image/") === 0;
        const isVideo = mimeType.indexOf("video/") === 0 || mimeType.indexOf("audio/") === 0;
        if (!isImage && !isVideo) continue;

        const mediaElement = isImage ? `<img src='${mediaPath}'>` : `<video class="image" muted src='${mediaPath}'></video>`;

        wrapElement.append(`
  <div class="item media-element-item" data-media-element-id="${mediaFile._id}" data-media-element-file-name="${mediaFile.fileName}">
    <div class="ui tiny image images grabbable">
    ${mediaElement}
    </div>
    <div class="middle aligned content">
      <div class="header">
        ${mediaFile.fileName}
      </div>
      <div class="meta">
        Dauer in Sekunden<input type="number" name="duration" class="duration-change-input" value="${mediaFile.duration}">
      </div>
      <div class="meta">
        <div class="ui right floated basic button clone-media-btn" tabindex="0">
          <div class="hidden content">clone</div>
          <div class="visible content">
            <i class="clone icon"></i>
          </div>
        </div>
        <div class="ui right floated basic button remove-media-btn" tabindex="0">
          <div class="hidden content">remove</div>
          <div class="visible content">
            <i class="archive icon"></i>
          </div>
        </div>
        <div class="ui right floated basic button delete-media-btn" tabindex="0">
          <div class="hidden content">delete</div>
          <div class="visible content">
            <i class="trash icon"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
`
        )
      }
      $(".clone-media-btn", wrapElement).on('click', (event) => {
        const mediaElementID = $(event.target).closest('.media-element-item').attr('data-media-element-id');
        if(typeof mediaElementID === 'string' && mediaElementID.length > 0) {
          cloneMediaElement(mediaElementID);
        }
      });
      $(".remove-media-btn", wrapElement).on('click', showRemoveMediaElementConfirmModal);
      $(".delete-media-btn", wrapElement).on('click', showDeleteMediaElementConfirmModal);
      wrapElement.sortable({
        handle: ".grabbable",
        onUpdate: event => {
          const playlistChangedOrder = [];
          $(event.to).children('.media-element-item').each((i, item) => {
            playlistChangedOrder.push({
              _id: $(item).attr('data-media-element-id'),
              orderIndex: i
            });
          });
          updatePlaylistOrder(playlistChangedOrder);
        }
      });
      $(".duration-change-input").on('focusout', (event) => {
        let _currentMediaElementItemJQ = $(event.target).closest('.media-element-item');
        let duration = parseInt($(event.target).val());
        if (!isNaN(duration) && duration > 0) {
          updateFile(_currentMediaElementItemJQ.attr('data-media-element-id'), {
            duration: duration
          });
        }
      });
    });

    $('#uploadForm').submit(function () {
      const status = $("#status")
      status.empty().text("File is uploading...");
      $(this).ajaxSubmit({
        error: function (xhr) {
          status.empty().text('Error: ' + xhr.status + ' ' + xhr.message);
          logError("cannot submit files", { message: xhr.message});
        },
        success: function (response) {
          console.log(response);
          status.empty().text(response);
        }
      });
      return false;
    });


    emitResult(getPlaylist, "playlist-updated", "playlist");

  });

</script>
</body>
</html>
