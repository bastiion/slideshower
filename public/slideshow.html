<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/kioskboard/dist/kioskboard-1.4.0.min.css" />
  <link rel="stylesheet" href="/materialize-css/dist/css/materialize.min.css">
  <title>Slideshow</title>
  <style>
    body {
      background-color: black;
      margin: 0;
    }

    .slideshow > video.media-element {
      display: none;
    }

    .slideshow > img.media-element {
      display: block;
    }

    .slideshow[data-video-is-active] > img.media-element {
      display: none;
    }

    .slideshow[data-video-is-active] > video.media-element {
      display: block;
    }

    .slideshow video {
      object-fit: contain;
    }

    .slideshow {
      text-align: center;
    }

    .media-element {
      margin-left: auto;
      margin-right: auto;
      max-width: 100%;
      height: 100vh;
    }

    .dialog {
      position: absolute;
      top: calc(50% - 100px);
      left: calc(50% - 200px);
      height: 200px;
      width: 400px;
      background-color: rgba(50,50,50, 0.8);
      padding: 16px;

    }
     .pinentry {
       display: flex;
       flex-direction: column;
       justify-content: center;
       align-items: center;
     }
  </style>
</head>
<body>
<div class="slideshow">
  <img class="media-element image" id="imgSlide" src="" alt="">
  <video class="media-element video" autoplay muted id="videoSlide" src="" alt=""></video>
</div>
<div class="pinentry dialog">
  <input class="virtual-keyboard pin" data-kioskboard-type="numpad" placeholder="Bitte eine Pin eingeben" />
  <div class="row">
    <a class="cancel-btn waves-effect waves-light btn red">abbrechen</a>
    <a class="okay-btn waves-effect waves-light btn">okay</a>
  </div>

</div>
<script src="/public/sha.js"></script>
<script src="/jquery/dist/jquery.min.js"></script>
<script src="/robust-websocket/robust-websocket.js"></script>
<script src="/vanilla-fade/dist/vanilla-fade.js"></script>
<script src="/imagesloaded/imagesloaded.pkgd.min.js"></script>
<script src="/kioskboard/dist/kioskboard-1.4.0.min.js"></script>
<script src="/materialize-css/dist/js/materialize.min.js"></script>
<script src="/public/client.js"></script>
<script src="/public/initKioskboard.js"></script>
<script>
  let playlist = [];
  let imageIndex = -1;
  let currentMediaFile;
  let timer;
  let started = false;
  let paused = false;
  let videoDisabled = true;
  let playingExternally = false;

  let emergencyTimeoutMS = 1000*60*15;
  let emergencyTimer = null;
  resetEmergencyReloadTimer();

  $('.pinentry.dialog').hide();
  $('.pinentry .cancel-btn').on('click', () => {
    $('.pinentry .pin').val('');
    $('.pinentry.dialog').hide();
  })
  $('.pinentry .okay-btn').on('click', () => {
    const pin = $('.pinentry .pin').val();
    if(pin === '2142') {
      $('.pinentry .pin').val('');
      window.location.replace("http://localhost:3000/");
    }
  })

  let clickedDocument = 0
  let clickResetTimer = null

  $('.slideshow').on('click', () => {
    clickedDocument++
    if(!clickResetTimer) {
      clickResetTimer = setTimeout(function () {
        clickedDocument = 0;
        clickResetTimer = null;
      }, 2000);
    }
    if(clickedDocument === 5) {
      $('.pinentry.dialog').show();
      clickedDocument = 0;
      if(clickResetTimer) {
        clearTimeout(clickResetTimer);
        clickResetTimer = null;
      }
    }
  })

  $(document).on("playlist-updated", (event) => {
    const playl = event.detail.playlist;
    if (!Array.isArray(playl)) {
      playlist = [];
      return;
    }
    playlist = playl;
    if (!started) {
      started = true;
      nextSlide();
    }
  });

  $(document).on("new-elements-added", (event) => {
    const newElement = event.detail.newElements[0];
    if (!newElement) return;
    showMediaElement(newElement);

  });
  const slideshowElement = $(".slideshow");
  const videoSlideElement = $("#videoSlide");
  videoSlideElement.on('pause', () => {
    updateSlideshowSession()
  });
  videoSlideElement.on('play', () => {
    updateSlideshowSession()
  });
  videoSlideElement.on('ended', () => {
    if(!paused) {
      console.log('video ended will invoke nextSlide');
      nextSlide();
    }
  });
  $(document).keydown(function (e) {
    switch (e.which) {
      case 37: // left
        nextSlide(-1);
        break;
      case 38: // up
        break;
      case 39: // right
        nextSlide();
        break;
      case 40: // down
        break;
      default:
        return; // exit this handler for other keys
    }
    e.preventDefault(); // prevent the default action (scroll / move caret)
  });
  $(document).on("player-volume-updated", (event) => {
    //console.log(event);
    const volume = event.detail.volume;
    try {
      if(volume < 0.01) {
        videoSlideElement[0].muted = true;
      } else {
        videoSlideElement[0].muted = false;
      }
      videoSlideElement[0].volume = volume;
    } catch(err) {
      logError("Cannot set volume of video element", err);
    }
  });
  $(document).on("slideshow-pause-wish", (event) => {
    paused = true;
    videoSlideElement[0].pause();
    window.clearTimeout(timer);
    updateSlideshowSession();
  });
  $(document).on("slideshow-play-wish", (event) => {
    paused = false;
    nextSlide();
  });
  $(document).on("external-play-finish", (event) => {
    playingExternally = false;
    nextSlide();
  });
  $(document).on("video-play-wish", (event) => {
    logError("Cannot invoke play on video", new Error("Bal bluvb"));
    videoSlideElement[0].play().then(() => {
      console.log("video play successfull");
    }).catch((err) => {
      logError("Cannot invoke play on video", err);
    });
  });
  $(document).on("video-pause-wish", (event) => {
    videoSlideElement[0].pause().then(() => {
      console.log("video pause successfull");
    }).catch((err) => {
      logError("Cannot invoke pause on video", err);
    });
  });
  $(document).on("next-slide-wish", (event) => {
    nextSlide();
  });
  $(document).on("specific-slide-wish", (event) => {
    const mediaElementID =  event.detail.mediaElementID;
    const index = playlist.findIndex(item => item._id === mediaElementID);
    if(index >= 0) {
      showMediaElement(playlist[index]);
    }
  });
  $(document).on("previous-slide-wish", (event) => {
    nextSlide(-1);
  });

  function showMediaElement(mediaFile) {
    //possibly clear the timer (if manually skipped this is important) and pause video
    resetEmergencyReloadTimer();
    currentMediaFile = mediaFile;
    updateSlideshowSession();
    if (timer) {
      window.clearTimeout(timer);
    }
    videoSlideElement[0].pause();
    const mediaPath = uploadPath + mediaFile.fileName;
    const isImage = mediaFile.mimeType.indexOf("image/") === 0;
    const isVideo = mediaFile.mimeType.indexOf("video/") === 0 || mediaFile.mimeType.indexOf("audio/") === 0;
    if (!isImage && !isVideo)
      return;

    const imgSlideElement = $(".media-element.image");
    let newImgSlideElement;
    if (!isVideo) {
      newImgSlideElement = $(`<img class="media-element image" src="${mediaPath}" alt="${mediaFile}">`)

      newImgSlideElement.imagesLoaded()
          .always(() => {
            transitionToNewMedia();
          });
    } else {
      transitionToNewMedia();
    }
    function transitionToNewMedia() {
      slideshowElement[0].fadeOut(duration = 250, easing = 'linear', complete = () => {
        if (isVideo) {
          if(videoDisabled) {
            resetEmergencyReloadTimer(1000*60);
            invokeExternalPlay(currentMediaFile._id).then((resp) => {
              if(resp.ok) {
                playingExternally = true
              } else {
                playingExternally = false;
                logError("cannot invoke external play", resp.statusText);
                nextSlide();
              }

            }).catch( err => {
              playingExternally = false;
              logError("cannot request invokeExternalPlay", err);
              nextSlide();
            });
          } else {
            slideshowElement.attr('data-video-is-active', true);
            videoSlideElement.attr('src', mediaPath);
            if (!paused) {
              timer = window.setTimeout(() => nextSlide(), mediaFile.duration * 1000 + 200);
            }
          }
        } else {
          slideshowElement.attr('data-video-is-active', null);
          //imgSlideElement.attr('src', mediaPath);
          imgSlideElement.replaceWith(newImgSlideElement);
          if (!paused) {
            timer = window.setTimeout(() => nextSlide(), mediaFile.duration * 1000 + 200);
          }
        }
        setTimeout(() => {
          slideshowElement[0].fadeIn(duration = 250, easing = 'linear', complete = null)
        }, 20);
      });
    }

  }

  function resetEmergencyReloadTimer(_timeout) {
    const timeout = _timeout ||  emergencyTimeoutMS;
    if(emergencyTimer) {
      clearTimeout(emergencyTimer);
    }
    emergencyTimer = setTimeout(() => window.location.reload(), timeout);
  }

  function nextSlide(addSubstractNum) {
    if (playlist.length <= 0)
      return;

    let num = parseInt(addSubstractNum);
    if (isNaN(num) || num === 0)
      num = 1;

    imageIndex += num;

    if (playlist.length <= imageIndex)
      imageIndex = 0;
    if (imageIndex < 0)
      imageIndex = playlist.length - 1;

    const mediaFile = playlist[imageIndex];
    showMediaElement(mediaFile);
  }

  function updateSlideshowSession() {
    const mediaFile = currentMediaFile || playlist[imageIndex];
    sendCommand('sessionUpdate', {
      currentMediaElementId: mediaFile._id,
      currentMediaElementFileName: mediaFile.fileName,
      currentMediaElementMimeType: mediaFile.mimeType,
      playerVolume: videoSlideElement[0].volume,
      playerPos: videoSlideElement[0].currentTime,
      playerPaused: videoSlideElement[0].paused,
      slideshowPaused: paused,
    });
  }

</script>

</body>
</html>
